SQL> SET ECHO ON
SQL> /*
SQL> CIS 353 - Database Design Project
SQL> Scott Nguyen
SQL> Jake Miller
SQL> Brandon Thedorff
SQL> Alen Huric
SQL> */
SQL> DROP TABLE Account CASCADE CONSTRAINTS;

Table dropped.

SQL> DROP TABLE GameAccount CASCADE CONSTRAINTS;

Table dropped.

SQL> DROP TABLE Region CASCADE CONSTRAINTS;

Table dropped.

SQL> DROP TABLE Transaction CASCADE CONSTRAINTS;

Table dropped.

SQL> DROP TABLE FinancialHistory CASCADE CONSTRAINTS;

Table dropped.

SQL> DROP TABLE InGameItems CASCADE CONSTRAINTS;

Table dropped.

SQL> DROP TABLE GameType CASCADE CONSTRAINTS;

Table dropped.

SQL> DROP TABLE InRegion CASCADE CONSTRAINTS;

Table dropped.

SQL> --
SQL> --CREATING THE TABLES
SQL> -------------------------------------------------------------------
SQL> CREATE TABLE Account
  2  (
  3  userAccID	     INTEGER	     NOT NULL,
  4  fName	     CHAR(10)	     NOT NULL,
  5  lName	     CHAR(15)	     NOT NULL,
  6  email	     CHAR(15)	     NOT NULL,
  7  --
  8  -- aIC1: Account IDs are unique
  9  CONSTRAINT aIC1 PRIMARY KEY(userAccID)
 10  );

Table created.

SQL> -------------------------------------------------------------------
SQL> CREATE TABLE Region
  2  (
  3  regionID	     CHAR(15)	     NOT NULL,
  4  rPRICE	     INTEGER,
  5  exclusives      INTEGER,
  6  --
  7  -- IC1: the region id is unique
  8  CONSTRAINT IC1 PRIMARY KEY(regionID),
  9  --rIC2: the price is greater or equal to 0 and greater than or equal to 0 exclusives
 10  CONSTRAINT IC2 CHECK (rPRICE >= 0 AND exclusives >= 0),
 11  --rIC3: Every GameAccount has a Region associated with it
 12  CONSTRAINT IC3 CHECK (regionID IN('NTSC-J', 'NTSC-U', 'PAL', 'NTSC-C'))
 13  );

Table created.

SQL> -------------------------------------------------------------------
SQL> CREATE TABLE GameAccount
  2  (
  3  gameAccID	     INTEGER  NOT NULL,
  4  lvl	     INTEGER,
  5  rank	     INTEGER,
  6  status	     CHAR(10),
  7  name	     CHAR(15),
  8  transNum		     INTEGER,
  9  transDate	     DATE,
 10  gRegionID	     CHAR(15) NOT NULL,
 11  gUserID	     INTEGER,
 12  -- gIC1: Game account IDS are unique
 13  CONSTRAINT gIC1 PRIMARY KEY(gameAccID),
 14  --gIC2: Checks the level is 1 or greater
 15  CONSTRAINT gIC2 CHECK (lvl >= 1),
 16  --gIC3: Checks the status to be available or sold
 17  CONSTRAINT gIC3 CHECK (status IN('available', 'sold')),
 18  CONSTRAINT gIC4 FOREIGN KEY (gRegionID) REFERENCES Region(regionID)
 19  	     ON DELETE CASCADE,
 20  CONSTRAINT gIC5 FOREIGN KEY (gUserID) REFERENCES Account(userAccID)
 21  	     ON DELETE CASCADE
 22  );

Table created.

SQL> -------------------------------------------------------------------
SQL> CREATE TABLE Transaction
  2  (
  3  confirmNum      INTEGER,
  4  payMethod	     CHAR(15),
  5  accntDate	     DATE,
  6  accntPrice      INTEGER,
  7  soldBy	     INTEGER NOT NULL,
  8  purchasedBy     INTEGER NOT NULL,
  9  --
 10  -- tIC1: The confirmation number is unique
 11  CONSTRAINT tIC1 PRIMARY KEY (confirmNUM),
 12  -- tIC2: transactions can only be completed by user accounts
 13  CONSTRAINT tIC2 FOREIGN KEY (soldBy) REFERENCES Account(userAccID)
 14  	     ON DELETE CASCADE,
 15  --tlC3: purchased by refers to user accounts
 16  CONSTRAINT tlC3 FOREIGN KEY(purchasedBy) REFERENCES Account(userAccID)
 17  	     ON DELETE CASCADE
 18  );

Table created.

SQL> -------------------------------------------------------------------
SQL> CREATE TABLE FinancialHistory
  2  (
  3  fUserAccID      INTEGER	     NOT NULL,
  4  year	     INTEGER	     NOT NULL,
  5  sold	     INTEGER,
  6  purchased	     INTEGER,
  7  --
  8  -- fIC1: the user account is unique
  9  CONSTRAINT fIC1 PRIMARY KEY(fUserAccID, year),
 10  --flC2: foreign key that user account ID references to
 11  CONSTRAINT fIC2 FOREIGN KEY(fUserAccID) REFERENCES Account(userAccID)
 12  	     ON DELETE CASCADE
 13  );

Table created.

SQL> ------------------------------------------------------------------
SQL> CREATE TABLE InGameItems
  2  (
  3  inGameAccID     INTEGER NOT NULL,
  4  ingameItems     CHAR(15),
  5  --
  6  --bC1 the primary keys for this table
  7  CONSTRAINT bC1 PRIMARY KEY (inGameAccID, ingameItems),
  8  --bC2 the game account references to game account table
  9  CONSTRAINT bC2 FOREIGN KEY(InGameAccID) REFERENCES GameAccount(gameAccID)
 10  	     ON DELETE CASCADE
 11  );

Table created.

SQL> -------------------------------------------------------------------
SQL> CREATE TABLE GameType
  2  (
  3  tGameUserAccID  INTEGER,
  4  type    CHAR(15),
  5  --
  6  --gtC1 the primary keys for this type
  7  CONSTRAINT gtC1 PRIMARY KEY (tGameUserAccID, type),
  8  --gtC2 the game account references the game account table
  9  CONSTRAINT gtC2 FOREIGN KEY(tGameUserAccID) REFERENCES GameAccount(gameAccID)
 10  	     ON DELETE CASCADE
 11  );

Table created.

SQL> -------------------------------------------------------------------
SQL> CREATE TABLE InRegion
  2  (
  3  iRegionID	     CHAR(15)	     NOT NULL,
  4  iGameID	     INTEGER,
  5  --
  6  --iiC2 the primary keys for this table
  7  CONSTRAINT iiC1 PRIMARY KEY (iRegionID, iGameID),
  8  --iiC3 game ID references game account
  9  CONSTRAINT iiC3 FOREIGN KEY (iRegionID) REFERENCES Region(regionID)
 10  	     ON DELETE CASCADE,
 11  --iiC4 user id references user account
 12  CONSTRAINT iiC4 FOREIGN KEY(iGameID) REFERENCES GameAccount(GameAccID)
 13  	     ON DELETE CASCADE
 14  );

Table created.

SQL> -------------------------------------------------------------------
SQL> SET FEEDBACK OFF
SQL> -------------------------------------------------------------------
SQL> -- Populating the Tables
SQL> -------------------------------------------------------------------
SQL> INSERT INTO Account VALUES (1, 'Jake', 'Miller', 'nobody@mail.com');
SQL> INSERT INTO Account VALUES (2, 'Scott', 'Nguyen', 'some@mail.com');
SQL> INSERT INTO Account VALUES (3, 'Alen', 'Huric', 'every@gmail.com');
SQL> INSERT INTO Account VALUES (4, 'Brandon', 'Thedorf', 'people@mail.com');
SQL> INSERT INTO Account VALUES (5, 'Joe', 'Smith', 'blah@gmail.com');
SQL> INSERT INTO Account VALUES (6, 'Smith', 'Joe', 'bam@mail.com');
SQL> INSERT INTO Account VALUES (7, 'Bob', 'Builders', 'bobd@gmail.com');
SQL> INSERT INTO Account VALUES (8, 'Dragon', 'Ballz', 'dbzlol@mail.com');
SQL> -------------------------------------------------------------------
SQL> INSERT INTO Region VALUES ('NTSC-J', 10, 50);
SQL> INSERT INTO Region VALUES ('NTSC-U', 15, 75);
SQL> INSERT INTO Region VALUES ('PAL', 100, 25);
SQL> INSERT INTO Region VALUES ('NTSC-C', 25, 150);
SQL> -------------------------------------------------------------------
SQL> INSERT INTO GameAccount VALUES (1, 1, 1, 'available', 'Minecraft', NULL, NULL, 'PAL', 1);
SQL> INSERT INTO GameAccount VALUES (2, 10, 10, 'available', 'CSGO', NULL, NULL, 'NTSC-J', 4);
SQL> INSERT INTO GameAccount VALUES (3, 10, 1, 'available', 'WoW', NULL, NULL, 'NTSC-U', 5);
SQL> INSERT INTO GameAccount VALUES (4, 7, 10, 'sold', 'Destiny', 123, TO_DATE('10/12/13', 'MM/DD/YY'), 'NTSC-C', 2);
SQL> INSERT INTO GameAccount VALUES (5, 8, 11, 'sold', 'Fallout 76',321, TO_DATE('12/14/15', 'MM/DD/YY'), 'PAL',3);
SQL> INSERT INTO GameAccount VALUES (6, 1, 1, 'available', 'Minecraft', NULL, NULL, 'PAL', 1);
SQL> ------------------------------------------------------------------
SQL> INSERT INTO Transaction VALUES (123, 'Credit Card', TO_DATE('11/12/13' , 'MM/DD/YY'), 100, 4, 2);
SQL> INSERT INTO Transaction VALUES (321, 'Credit Card', TO_DATE('12/14/15' , 'MM/DD/YY'), 150, 5, 3);
SQL> -------------------------------------------------------------------
SQL> INSERT INTO FinancialHistory VALUES (1, 1999, NULL, NULL);
SQL> INSERT INTO FinancialHistory VALUES (2, 2013, 1, 1);
SQL> INSERT INTO FinancialHistory VALUES (3, 2015, 0, 1);
SQL> INSERT INTO FinancialHistory VALUES (4, 2013, 1, 1);
SQL> INSERT INTO FinancialHistory VALUES (5, 2015, 1, 0);
SQL> INSERT INTO FinancialHistory VALUES (6, 1998, NULL, NULL);
SQL> INSERT INTO FinancialHistory VALUES (7, 1997, NULL, NULL);
SQL> INSERT INTO FinancialHistory VALUES (8, 2020, NULL, NULL);
SQL> -------------------------------------------------------------------
SQL> INSERT INTO InGameItems VALUES (1, 'Diamond');
SQL> INSERT INTO InGameItems VALUES (2, 'HyperBeast');
SQL> INSERT INTO InGameItems VALUES (3, 'Dung');
SQL> INSERT INTO InGameItems VALUES (4, 'Ice Breaker');
SQL> INSERT INTO InGameItems VALUES (5, 'Big Boy');
SQL> INSERT INTO InGameItems VALUES (1, 'Coal');
SQL> -------------------------------------------------------------------
SQL> INSERT INTO GameType VALUES (1, 'Sandbox');
SQL> INSERT INTO GameType VALUES (2, 'FPS');
SQL> INSERT INTO GameType VALUES (3, 'MMORPG');
SQL> INSERT INTO GameType VALUES (4, 'FPS');
SQL> INSERT INTO GameType VALUES (5, 'RPG');
SQL> -------------------------------------------------------------------
SQL> INSERT INTO InRegion VALUES ('NTSC-U', 1);
SQL> INSERT INTO InRegion VALUES ('NTSC-U', 2);
SQL> INSERT INTO InRegion VALUES ('NTSC-J', 1);
SQL> INSERT INTO InRegion VALUES ('PAL', 2);
SQL> INSERT INTO InRegion VALUES ('PAL', 3);
SQL> INSERT INTO InRegion VALUES ('NTSC-U', 3);
SQL> INSERT INTO InRegion VALUES ('NTSC-C', 5);
SQL> -------------------------------------------------------------------
SQL> SET FEEDBACK ON
SQL> COMMIT;

Commit complete.

SQL> -------------------------------------------------------------------
SQL> /* Q1 -- max query */
SQL> /* Finds the maximum Level and minimum Rank from gameAccount */
SQL> SELECT MAX(lvl) "maxLevel", MIN(rank) "minRank"
  2  FROM GameAccount;

  maxLevel    minRank                                                           
---------- ----------                                                           
        10          1                                                           

1 row selected.

SQL> 
SQL> /* Q2 --  sum query */
SQL> /* Finds the total sold and purchased game accounts */
SQL> SELECT SUM(sold) "sumSold", SUM(purchased) "sumPurchased"
  2  FROM FinancialHistory;

   sumSold sumPurchased                                                         
---------- ------------                                                         
         3            3                                                         

1 row selected.

SQL> 
SQL> /* Q3 -- intersect query */
SQL> /* Finds user account ID’s with google emails that have a game account */
SQL> SELECT userAccID
  2  FROM Account
  3  WHERE email LIKE '%@gmail.com'
  4  INTERSECT
  5  Select a.userAccID
  6  FROM Account a, GameAccount g
  7  WHERE a.userAccID = g.gUserID;

 USERACCID                                                                      
----------                                                                      
         3                                                                      

1 row selected.

SQL> 
SQL> /* Q4 -- self join query */
SQL> /* Finds the user account ID's that made atleast one sale in the same year */
SQL> SELECT f1.fUserAccID, f2.fUserAccID
  2  FROM FinancialHistory f1, FinancialHistory f2
  3  WHERE f1.sold > 0 AND
  4  	     f1.year = f2.year AND
  5  	     f1.fUserAccID < f2.fUserAccID;

FUSERACCID FUSERACCID                                                           
---------- ----------                                                           
         2          4                                                           

1 row selected.

SQL> 
SQL> /* Q5 -- relational division query */
SQL> /*Finds every game account in the region PAL and returns the user account ID and their first name */
SQL> SELECT g.gameAccID
  2  FROM GameAccount g
  3  WHERE NOT EXISTS ((SELECT r.iRegionID
  4  				     FROM InRegion r
  5  				     WHERE r.iRegionID = 'PAL')
  6  			     MINUS
  7  			     (SELECT r1.iRegionID
  8  			     FROM InRegion r1
  9  			     WHERE  g.gRegionID = r1.iRegionID AND
 10  			     r1.iRegionID = 'PAL'))
 11  ORDER BY g.gameAccID;

 GAMEACCID                                                                      
----------                                                                      
         1                                                                      
         5                                                                      
         6                                                                      

3 rows selected.

SQL> 
SQL> /* Q6 -- non-correlated query */
SQL> /* Finds game accounts who have a level higher than 1 and game accounts with financial history greater than 2013*/
SQL> SELECT gameAccID
  2  FROM GameAccount
  3  WHERE lvl > 1 AND
  4  	     gUserID IN (SELECT fUserAccID
  5  				     FROM FinancialHistory
  6  				     WHERE year > 2013);

 GAMEACCID                                                                      
----------                                                                      
         5                                                                      
         3                                                                      

2 rows selected.

SQL> 
SQL> /* Q7 -- TOP-N query */
SQL> /* Finds the top 3 region prices */
SQL> SELECT rPrice
  2  FROM (SELECT rPrice
  3  	     FROM Region
  4  	     ORDER BY rPrice DESC)
  5  WHERE ROWNUM <=3;

    RPRICE                                                                      
----------                                                                      
       100                                                                      
        25                                                                      
        15                                                                      

3 rows selected.

SQL> 
SQL> /* Q8 -- joining 4 tables query */
SQL> /* Finds every game account in a region that has been sold and who purchased it */
SQL> SELECT g.gameAccID, r.regionID, g.status, a.fName
  2  FROM Account a, Region r, GameAccount g, Transaction t
  3  WHERE a.userAccID = g.gUserID AND
  4  	     g.gRegionID = r.regionID AND
  5  	     g.transNum = t.confirmNum AND
  6  	     t.purchasedBy = a.userAccID AND
  7  	     g.status = 'sold'
  8  ORDER BY a.fName;

 GAMEACCID REGIONID        STATUS     FNAME                                     
---------- --------------- ---------- ----------                                
         5 PAL             sold       Alen                                      
         4 NTSC-C          sold       Scott                                     

2 rows selected.

SQL> 
SQL> /* Q9 -- correlated query */
SQL> /* Finds the game account ID’s with FPS game type*/
SQL> SELECT g.tGameUserAccID
  2  FROM GameType g
  3  WHERE g.type IN (SELECT type
  4  		     FROM GameType t
  5  		     WHERE t.type = 'FPS')
  6  ORDER BY tGameUserAccID;

TGAMEUSERACCID                                                                  
--------------                                                                  
             2                                                                  
             4                                                                  

2 rows selected.

SQL> 
SQL> /* Q10 -- outer join query */
SQL> /* Find the ID, first name, and last name for Account holder. Also show gUserAccID for those who have them */
SQL> SELECT a.UserAccID, a.fName, a.Lname
  2  FROM Account A LEFT OUTER JOIN GameAccount g ON a.UserAccID = g.gUserID;

 USERACCID FNAME      LNAME                                                     
---------- ---------- ---------------                                           
         1 Jake       Miller                                                    
         4 Brandon    Thedorf                                                   
         5 Joe        Smith                                                     
         2 Scott      Nguyen                                                    
         3 Alen       Huric                                                     
         1 Jake       Miller                                                    
         8 Dragon     Ballz                                                     
         6 Smith      Joe                                                       
         7 Bob        Builders                                                  

9 rows selected.

SQL> 
SQL> /* Q11 -- GROUP BY, HAVING, and ORDER BY query */
SQL> /* Finds the total ingame items each game account has */
SQL> SELECT a.userAccID, x.ingameItems, COUNT(x.inGameAccID) "Total"
  2  FROM Account a, GameAccount g, InGameItems x
  3  WHERE a.userAccID = g.gUserID AND
  4  	     g.gameAccID = x.inGameAccID
  5  GROUP BY a.userAccID, x.ingameItems
  6  HAVING COUNT(x.ingameAccID) > 0
  7  ORDER BY a.userAccID;

 USERACCID INGAMEITEMS          Total                                           
---------- --------------- ----------                                           
         1 Coal                     1                                           
         1 Diamond                  1                                           
         2 Ice Breaker              1                                           
         3 Big Boy                  1                                           
         4 HyperBeast               1                                           
         5 Dung                     1                                           

6 rows selected.

SQL> 
SQL> /* Q12 -- rank query */
SQL> /* Finds the rank of the account(s) that sold for $100  */
SQL> SELECT RANK(100) WITHIN GROUP
  2  	     (ORDER BY t.accntPrice) "RANK OF 100"
  3  FROM Transaction t;

RANK OF 100                                                                     
-----------                                                                     
          1                                                                     

1 row selected.

SQL> -------------------------------------------------------------------
SQL> /* Testing: aIC1 */
SQL> INSERT INTO Account VALUES (1, 'Jake', 'Miller', 'nobody@mail.com');
INSERT INTO Account VALUES (1, 'Jake', 'Miller', 'nobody@mail.com')
*
ERROR at line 1:
ORA-00001: unique constraint (MILLEJA1.AIC1) violated 


SQL> 
SQL> /* Testing: gtC2 */
SQL> INSERT INTO GameType VALUES (8, 'Sandbox');
INSERT INTO GameType VALUES (8, 'Sandbox')
*
ERROR at line 1:
ORA-02291: integrity constraint (MILLEJA1.GTC2) violated - parent key not found 


SQL> 
SQL> /* Testing: gIC2 */
SQL> UPDATE GameAccount SET lvl = 0;
UPDATE GameAccount SET lvl = 0
*
ERROR at line 1:
ORA-02290: check constraint (MILLEJA1.GIC2) violated 


SQL> 
SQL> /* Testing: IC3 */
SQL> UPDATE Region SET rPrice = -1;
UPDATE Region SET rPrice = -1
*
ERROR at line 1:
ORA-02290: check constraint (MILLEJA1.IC2) violated 


SQL> UPDATE Region SET exclusives = -1;
UPDATE Region SET exclusives = -1
*
ERROR at line 1:
ORA-02290: check constraint (MILLEJA1.IC2) violated 


SQL> 
SQL> COMMIT;

Commit complete.

SQL> -------------------------------------------------------------------
SQL> SPOOL OFF
